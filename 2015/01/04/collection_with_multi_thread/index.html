<!DOCTYPE html>
<html lang="en">
	<head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<meta charset="utf-8"/>
		<title>
		 Java Collection과 멀티쓰레드 -
		
		 soy blog</title>
		<!-- For responsive site
			<meta name="viewport" content="width=device-width, initial-scale=1.0">
		-->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<link rel="author" href="/humans.txt">
		<meta name="description" content="Description Goes Here">
		<link rel="stylesheet" href="/css/style.css">
		<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

		<!--[if IE 7]>
			<html class="ie7"> 
			<link rel="stylesheet" type="text/css" href="/css/font-awesome-ie7.min.css">
		<![endif]-->
		<!--[if IE 8]><html class="ie8"> <![endif]-->		
	    <!--[if lt IE 9]>
	      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	    <![endif]-->

		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

		  ga('create', 'UA-92395927-1', 'auto');
		  ga('send', 'pageview');
		</script>

		<link rel="apple-touch-icon" sizes="57x57" href="/ico/apple-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/ico/apple-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/ico/apple-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/ico/apple-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/ico/apple-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/ico/apple-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/ico/apple-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/ico/apple-icon-152x152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/ico/apple-icon-180x180.png">
		<link rel="icon" type="image/png" sizes="192x192"  href="/ico/android-icon-192x192.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/ico/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="96x96" href="/ico/favicon-96x96.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/ico/favicon-16x16.png">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#ffffff">
		<meta name="msapplication-TileImage" content="/ico/ms-icon-144x144.png">
		<meta name="theme-color" content="#ffffff"> 
	</head>
	<body>
	<!-- Header
	    ================================================== -->
	<header>
	</header>

	







<main class="content">
    <section class="container">
    	<div class="row-fluid">
			<article class="top-menu">
				<a href="/" class="menu-icon" data-toggle="tooltip" title="HOME"><i class="fa fa-home"></i></a>
<a href="/about/" class="menu-icon" data-toggle="tooltip" title="ABOUT"><i class="fa fa-user"></i></a>
<a href="/category/diary/" class="menu-icon" data-toggle="tooltip" title="DIARY"><i class="fa fa-edit"></i></a>
      <a href="/category/blog/" class="menu-icon" data-toggle="tooltip" title="BLOG"><i class="fa fa-bars"></i></a>
      <a href="/tag/" class="menu-icon" data-toggle="tooltip" title="TAG"><i class="fa fa-tags"></i></a>
  <div class="top-line"></div>
 
			</article>

			

     	   <article class="diary">
       	 	   <div align=center><h2>Java Collection과 멀티쓰레드</h2></div>
       		   <div class="time"><a style="color:#777" href="http://3.34.122.196:7500/edit/2015-01-04-collection_with_multi_thread.md"><i class="fa fa-calendar"></i></a> 04 January 2015</div>
				 <div class="tags"><a href="/tag/java/">#Java</a>, <a href="/tag/thread/">#Thread</a></div>
        		  <section class="diary_section">
     			  	 
           		  	  <div class="inner_content"><p>여러개의 인스턴스를 관리하는 인터페이스나 클래스를 총칭하여 컬렉션 이라고 한다.</p>
<blockquote>
  <p>java.util.List 인터페이스, java.util.ArrayList 클래스 등등..</p>
</blockquote>

<p>자바의 컬렉션은 대부분 thread-safety 하지 않다. 따라서 여러개의 쓰레드들이 동시에 컬렉션에 접근하는 경우에는 사용하고자 하는 컬렉션이 thread-safety 한지 아닌지 API 레퍼런스를 체크해볼 필요가 있다.</p>

<!-- more -->
<p>다음과 같이 세 개의 예제를 살펴본다.</p>

<ul>
  <li>1) thread-safety 하지 않은 java.util.ArrayList 클래스</li>
  <li>2) Collections.synchronizedList 메소드에 의한 동기화</li>
  <li>3) cow (copy-on-write) 를 사용한 java.util.concurrent.CopyOnWriteArrayList 클래스</li>
</ul>

<h3 id="1-thread-safety-하지-않은-javautilarraylist-클래스">1) thread-safety 하지 않은 java.util.ArrayList 클래스</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  
        <span class="n">List</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;();</span>    <span class="c1">// ArrayList는 thread-safety 하지 않음</span>
        <span class="k">new</span> <span class="nf">WriterThread</span><span class="o">(</span><span class="n">list</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>        <span class="c1">// WriterThread에서는 ArrayList를 write함</span>
        <span class="k">new</span> <span class="nf">ReaderThread</span><span class="o">(</span><span class="n">list</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>        <span class="c1">// ReaderThread에서는 ArrayList를 read함</span>
        <span class="c1">// ArrayList 인스턴스에 대해 read/write가 동시에 일어나므로 익셉션 발생</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReaderThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">;</span>
  
    <span class="kd">public</span> <span class="nf">ReaderThread</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="s">"ReaderThread"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">n</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>        <span class="c1">// iterator를 이용하여 list를 read</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WriterThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">;</span>
  
    <span class="kd">public</span> <span class="nf">WriterThread</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="s">"WriterThread"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="kc">true</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>     <span class="c1">// list에 write</span>
            <span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>  <span class="c1">// list에 write</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>ArrayList 클래스는 thread-safety 하지 않으므로 여러개의 쓰레드에서 동시에 읽고 쓰는 것은 안전하지 않다. ArrayList 클래스와 그 iterator는 안전성이 상실되었음을 검출하면 ConcurrentModificationException이라는 예외를 발생시킨다. 이것은 ‘수정이 동시에 이루어졌다’는 사실을 나타내는 런타임 익셉션이다. 또한 이 예제에서는 NullPointerException이 발생할 수 있다.</p>

<h3 id="2-collectionssynchronizedlist-메소드에-의한-동기화">2) Collections.synchronizedList 메소드에 의한 동기화</h3>
<p>java.util.ArrayList 클래스는 thread-safety 하지 않지만, Collections.synchronizedList 메소드를 이용하여 동기화하면 thread-satefy 인스턴스를 확보할 수 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
 
        <span class="c1">// ArrayList의 인스턴스를 synchronizedList() 메소드를 통하여 변수 list에 보관</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;()</span> <span class="o">);</span>
 
        <span class="k">new</span> <span class="nf">WriterThread</span><span class="o">(</span><span class="n">list</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>        <span class="c1">// WriterThread에서는 ArrayList를 write함.  </span>
        <span class="k">new</span> <span class="nf">ReaderThread</span><span class="o">(</span><span class="n">list</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>        <span class="c1">// ReaderThread에서는 ArrayList를 read함</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>ArrayList의 인스턴스를 Collections.synchronizedList 메소드를 통하여 변수 list에 보관한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReaderThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
  
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">;</span>
  
    <span class="kd">public</span> <span class="nf">ReaderThread</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="s">"ReaderThread"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">list</span><span class="o">)</span> <span class="o">{</span>           <span class="c1">// synchronized 블록 처리</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">n</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>        <span class="c1">// iterator를 이용하여 list를 read</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>ReaderThread 클래스의 run() 메소드에서, iterator를 이용해 ArrayList 인스턴스에 read 하는 부분을 synchronized 블록으로 감싸준다. WriterThread 클래스의 run() 메소드에서 ArrayList 인스턴스에 write 하는 부분은 synchronized 블록으로 감싸줄 필요가 없다. 여기에서는 add, remove 메소드를 명시적으로 호출하기 때문이다.</p>

<p>이렇게 변경하면 ConcurrentModificationException, NullPointerException이 발생하지 않는다.</p>

<h3 id="3-copy-on-write를-사용한-javautilconcurrentcopyonwritearraylist-클래스">3) copy-on-write를 사용한 java.util.concurrent.CopyOnWriteArrayList 클래스</h3>
<p>java.util.concurrent.CopyOnWriteArrayList 클래스는 thread-safety 하다. 이 클래스는 Collections.synchronizedList 메소드를 이용하여 동기화 시키는 위의 예제 2와는 달리, copy-on-write를 이용하여 충돌을 막는다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CopyOnWriteArrayList</span><span class="o">;</span>
  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;();</span>
  
        <span class="k">new</span> <span class="nf">WriterThread</span><span class="o">(</span><span class="n">list</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">ReaderThread</span><span class="o">(</span><span class="n">list</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
  
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>copy-on-write는 ‘write 할 때 copy 한다’는 의미. 컬렉션에 대하여 write를 할 때마다, 내부에 확보된 배열을 통째로 복사한다. 이렇게 통째로 복사를 하면 iterator를 사용하여 element들을 순서대로 읽어가는 도중에 element가 변경될 염려가 없다. 따라서 CopyOnWriteArrayList 클래스와 그 iterator가 ConcurrentModificationException을 발생시키는 일은 절대 없다. 단 write를 할 때마다 배열을 통째로 copy 하므로, write가 잦은 경우 성능이 저하될 수 있다. write가 적고 read가 빈번한 경우에 좋다.</p>

<hr />

<p>References: “Java 언어로 배우는 디자인 패턴 입문 - 멀티쓰레드편” Introduction 02</p>
</div>
        		  	  
<div style="float: left"></div>
<div class="comments">
	<div class="comments_wrapper" aria-hidden="true">
		<div class="heading">
			<a href="#content_div" onClick="comment_toggle('comment_hidden_2015-01-04-collection_with_multi_thread');">Comments</a>
		</div>
		<div id="comment_hidden_2015-01-04-collection_with_multi_thread" style="display: none;">
			<div class="line"></div>
			<div class="content_div">
				<script src="https://utteranc.es/client.js" repo="soyme/my-blog-comments" branch="master" issue-term="2015-01-04-collection_with_multi_thread" theme="github-light" crossorigin="anonymous" async></script>
			</div>
		</div>
	</div>
</div>
<div style="clear: both"></div>

        		  </section>
				  <section class="prev_next">
					
                        <a style="float: left;" href="/2015/01/03/concurrent/"><i class="icon-arrow-left"></i> 순차(sequential) vs 병렬(parallel) vs 병행(concurrent) 차이</a>
                    
					
						<a style="float:right; margin-bottom: 10px;"; href="/2015/01/09/mysql_oracle_migration/">MySQL 쿼리를 오라클 쿼리로 변경하기 <i class="icon-arrow-right"></i></a>
					
		  		  </section>
			</article>
		</div>
	</section>
</main>


	<footer>
  <div class="wrapper">
    <a href="#" class="menu-icon" data-toggle="tooltip" title="ABOUT"><i class="fa fa-arrow-up"></i></a>
  </div>
</footer>

	<copyright>
	</copyright>

	<!-- Javascripts 
	    ================================================= -->
	<script src="/js/jquery.min.js"></script>
	<script src="/js/custom.js"></script>
	<script type="text/template" id="template-comment">
	<div id="comment{index}" class="comment">
	<div class="comment_wrapper">
		<div class="comment_line"></div>
		<div>
		<span class="comment_name">
			
				<a rel="nofollow" href="{url}">{name}</a>
			
		</span>

		
			<span class="comment_date">, now</span> </div>
			<div class="comment_content">
			<p><em>This is a preview of your comment. It may take a couple of minutes for it to be displayed to others.</em></p>
		
		{message}</div>
	</div>
</div>
</script>

    <!-- Analytics
    ================================================== -->
    <script>
		// analytics code
    </script>	
	</body>
</html>
